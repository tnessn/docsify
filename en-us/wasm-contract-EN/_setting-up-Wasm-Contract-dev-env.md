## <a name="setting-up"></a>Setting up a Wasm Contract development environment

### Installing third party tools

In order to develop contracts under Windows you need the following:

* [cmake 3.0+](https://cmake.org/download/): For generating build files 
* [mingw 6.0.0+](https://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win64/Personal%20Builds/mingw-builds/8.1.0/threads-posix/seh/x86_64-8.1.0-release-posix-seh-rt_v6-rev0.7z/download): For compiling build files 
* [git-bash](https://git-scm.com/downloads): Highly recommended as it will be used many times throughout this guide.

1. Installing CMake

Install with the installer that comes with `cmake`. During the installation process, make sure you allow the PATH environment variable to be updated. If you missed it you can manually add the path of the `bin` folder under `cmake` to your PATH.

2. Installing mingw

The link provided is to the portable version, meaning that it can be used directly after decompressing the downloaded file and configuring the `PATH` environment variable. No installation needed.

### pWASM development kit

The pWASM development kit for Windows can be downloaded [here](https://download.platon.network/pWASM.zip).
The pWASM development kit is a compressed archive called `pWASM.gz`. After the download completes, extract it to any directory, such as `D:\`. This folder will be the working directory throughout this guide. After decompression all files will be located in a directory called `pWASM`. The file structure is as follows:


```txt
├──boost
├── CMakeModules
├── external
├── libc
├── libc++
├── platonlib
├── rapidjson
├── docs
├── script
├── user
├── CMakeLists.txt
└── README.md


```

What are the folders for?
* `external`: Used to store the binary packages needed in the compilation process, mainly including toolchains for generating `abi` and `bin` files.
* `user`: Energy contract examples; for reference only. Also used to store scripts for automatically generating template contract files.
* `platonlib`: A PlatON library used by contracts to interact with the blockchain. For details please see [Wasm Contract Built-in Library](https://pwasmdoc.platon.network/)


## <a name="write-contract"></a>Writing your first Wasm contract

Below we will show how to create a "Hello World" contract. It demonstrates how to store and query smart contracts on-chain, and to return the result to the caller through events.

### Creating a Wasm contract project

1. The build environment uses standard `cmake`. Make sure that `cmake` is correctly installed before building.

2. Execute the `git-bash.exe` file under Windows to open the `git-bash` window. `{pWASM}` is used below to refer to the location where you installed pWasm, for example `D:\pWASM`.

3. Use the script `{pWASM}/script/autoproject.bat` to quickly build a project directory. The command is as follows:

There are a few things to note before executing this script:

* Make sure that the `build` directory does not exist in the working directory. If it exists, please delete it.
* If there is an unexpected interruption during the first execution or if you have run the script before, please delete the `build` directory first.
* Script parameters control whether the script generates new contracts or rebuilds existing ones.

**Execute script to rebuild an existing contract:**


```shell
$ cd {pWASM}
$ ./script/autoproject.bat .


```

**Execute script to generate and build a new contract:**


```shell
$ cd {pWASM}
$ ./script/autoproject.bat . firstdemo


```

The `firstdemo` project will be generated by default in the `user` directory. The newly generated project directory structure is:


```text
├──build/ 
├──user/
  ├──firstdemo/
  ├── firstdemo.cpp
  └── CMakeLists.txt


```

What do the files do?
* `firstdemo.cpp`: The contract source file. New contract logic can be created with this as a reference.
* `CMakeLists.txt`: CMake file description

**Note: The generated .cpp file is empty. Please refer to the simple example below on how to write contracts:**

### Contract code example


```c++
#include <stdlib.h>
#include <string.h>
#include <string>
#include <platon/platon.hpp>

namespace demo {
    class FirstDemo : public platon::Contract
    {
        public:
            FirstDemo(){}

            /// Implementing a virtual function of the parent class platon::Contract 
            /// This function is executed once when the contract is first deployed
            void init() 
            {
                platon::println("init success...");
            }

            /// Define event
            PLATON_EVENT(Notify, uint64_t, const char *)

        public:
            void invokeNotify(const char *msg)
            { 
                // Set states variable
                platon::setState("NAME_KEY", std::string(msg));
                // log output
                platon::println("into invokeNotify...");
                // event returns
                PLATON_EMIT_EVENT(Notify, 0, "Insufficient value for the method.");
            }

            const char* getName() const 
            {
                std::string value;
                platon::getState("NAME_KEY", value);
                // read contract data and return
                return value.c_str();
            }
    };
}

// These functions will generate ABI files for calling the demo externally
PLATON_ABI(demo::FirstDemo, invokeNotify)
PLATON_ABI(demo::FirstDemo, getName)


```

### Compiling contracts

1. Contract compilation refers to the process of compiling the `.cpp` source into the required `abi` and `wasm` binaries (virtual machine instruction set).
2. Complete the contract deployment by replacing the default generated `firstdemo.cpp` file with the contract in the example.
3. Execute command to compile:


```shell
$ cd {pWASM}/build/
$ mingw32-make.exe


```

A new directory called `firstdemo` will be generated in the `build/user` directory together with the build target files:


```text
├──build/ 
  ├──user/
    ├──firstdemo/
      ├── firstdemo.s
      ├── firstdemo.bc 
      ├── firstdemo.wast 
      ├── firstdemo.wasm 
      ├── firstdemo.cpp.abi.json
      ├── firstdemo.cpp.bc 
      └── cmake_install.cmake


```

Main documents:

* `.bc`: Linked standard library LLVM bytecode files; including all dependent libraries
* `.json`: Contract interface description file
* `.s`: Assembly file
* `.wasm`: Contract compiled binary file, bytecode instruction set 
* `.wast`: Instruction file that can be read and understood after the contract is compiled
* `.cpp.bc`: LLVM bytecode file, containing only the contract code itself

**Please note**
Use `firstdemo.wast` and `firstdemo.cpp.abi.json` from the directory above for contract deployment.

**Please note**
The following error log is expected during compilation:


```code
Could not auto-detect compilation database for file "/workspace/pWASM/hello/hello.cpp"
No compilation database found in /workspace/pWASM/hello or any parent directory
json-compilation-database: Error while opening JSON database: No such file or directory


```

## <a name="deploy-and-test"></a>Deploying contracts and Testing

### Tool for testing and deploying

The PlatON platform provides a contract test tool called `ctool`:

- Windows version [click to download](https://download.platon.network/ctool-windows-amd64.exe)
- Linux version [click to download](https://download.platon.network/ctool-linux-amd64)

**ctool usage**:


```bash
$ mv ctool-windows-amd64.exe ctool.exe
$ ./ctool.exe <command> [--addr contractAddress] [--type txType(default:2)] [--func funcInfo] --abi <abi_path> --code <wasm_path> [--config <config_path >]


```

**Parameters:**

* `command`: The command to be executed. For more feature options, please run `./ctool.exe help`.
* `abi_path`: The path to the ABI file. In the example this is where the file `firstdemo.cpp.abi.json` is located.
* `wasm_path` : The path to the WASM file. In the example this is where the file `firstdemo.wasm` is located.
* `config_path` : The path to the configuration file. The configuration file is used for setting up [PlatON Nodes]([English]-Getting-Started) and account information.

**Please note:**
If the configuration file path is not explicitly set on the command line, a file with the name `config.json` will be read from the current working path. 

**Please note:**
To deploy a contract to the PlatON network, you need to connect to a node and make sure that the account used has been unlocked and that there is no timeout during deployment.

Configuration file example:


```JSON
{
  "url": "http://127.0.0.1:6789",
  "gas": "0x333330",
  "gasPrice": "0x333330",
  "from":"0x60ceca9c1290ee56b98d4e160ef0453f7c40d219"
}


```

Profile field description:

- `url`: PlatON node public JSON-RPC address 
- `from`: Address of account that is deploying the contract


### Deploying contracts

1. You can either deploy the Wasm contracts to the [Test Network]([English]-Getting-Started#Connect-to-the-Baleyworld-testnet) ,
or to our PlatON main network (not yet open). The only condition is that you already have an account in the network that holds a certain amount of Energon. If not, you can also build a [Private Network]([English]-Private-Networks) for testing.

2. For instructions on how to connect to a PlatON node, see the [Quick Start]([English]-Getting-Started#Connecting-to-the-network) guide.

3. Make sure that the `personal` RPC interface is enabled when the node starts. Unlock an account holding Energon and enter the account password:


```
> personal.unlockAccount("your-account")
Unlock account 0x2d616026162ad2d513691b790806fa6f6bc3c2ef
Passphrase:
true


```

4. Enter the build directory `{pWASM}/build/user/firstdemo` and create a `config.json` configuration file, and copy `ctool.exe` to the current directory. Then execute:


```shell
$ cd {pWASM}/build/user/firstdemo 
$ ./ctool.exe deploy --abi ./firstdemo.cpp.abi.json --code ./firstdemo.wasm --config ./config.json


```

5. After the command is successfully executed, the contract address will be returned:


```
transaction hash: 0xdb0f9a28fcd447702e8d5961f47144d1ea830979e3c984acc8f72c0dca8bdcfc
contract address: 0x43355c787c50b647c425f594b441d4bd751951c1


```
This address information is needed for making contract calls in the next step.

### Test contract

The contract has been successfully deployed. Now let's call it! The sample contract exposes the two methods `invokeNotify` and `getName`. First we initiate a transaction that calls `invokeNotify`, then call `getName` to get the value. The commands are as follows:

**Sending transaction**


```shell 
$ cd {pWASM}/build/user/firstdemo
$ ./ctool.exe invoke -addr "0x43355c787c50b647c425f594b441d4bd751951c1" --func 'invokeNotify("HelloWorld")' --abi ./firstdemo.cpp.abi.json --config ./config.json


```

**Querying transaction**


```shell 
$ cd {pWASM}/build/user/firstdemo
$ ./ctool.exe invoke -addr "0x43355c787c50b647c425f594b441d4bd751951c1" --func 'getName()' --abi ./firstdemo.cpp.abi.json --config ./config.json


```

> If the contract was successfully deployed and the transaction and query were successful the parameters passed to `invokeNotify` will be returned when querying `getName`.